  name: Build and Test on Pull Request

  on:
    pull_request:
      branches: [ * ]

  jobs:
    build-and-test:
      runs-on: ubuntu-latest

      steps:
        - uses: actions/checkout@v3

        - name: Set up JDK 17
          uses: actions/setup-java@v3
          with:
            java-version: '17'
            distribution: 'corretto'

        - name: Cache Gradle packages
          uses: actions/cache@v3
          with:
            path: ~/.gradle/caches
            key: ${{ runner.os }}-gradle-${{ hashFiles('**/gradle/build.gradle') }}
            restore-keys: |
              ~/.gradle/caches-*.zip

        - name: Grant execute permission for gradlew
          run: chmod +x gradlew

        - name: Copy Secret
          env:
            CREATE_SECRET_DIR: src/main/resources
            CREATE_SECRET_DIR_FILE_NAME: application.yml
          run: echo $CREATE_SECRET | base64 --decode > $CREATE_SECRET_DIR/$CREATE_SECRET_DIR_FILE_NAME

        - name: Build with Gradle
          uses: gradle/gradle-build-action@67421db6bd0bf253fb4bd25b31ebb98943c375e1
          with:
            arguments: clean build
          env:
            SPRING_PROFILES_ACTIVE: ${{ env.ACTIVE_PROFILE }}

        - name: Build and test with Gradle
          run: ./gradle test